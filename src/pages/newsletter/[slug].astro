---
import BaseLayout from "../../layouts/BaseLayout.astro";
import { getPost, listPostSlugs } from "../../lib/posts";

export async function getStaticPaths() {
  const slugs = listPostSlugs();
  return slugs.map((slug) => ({
    params: { slug },
  }));
}

const { slug } = Astro.params;
const post = await getPost(String(slug));
if (!post) {
  throw Astro.redirect("/newsletter/");
}

const dateFormatter = new Intl.DateTimeFormat("en-US", {
  month: "short",
  day: "numeric",
  year: "numeric",
});

const formatDate = (value: string) => {
  const parsed = new Date(value);
  return Number.isNaN(parsed.getTime()) ? value : dateFormatter.format(parsed);
};

const pageTitle = `${post.title} â€“ Newsletter`;
const heroDescription =
  post.excerpt ??
  "Essays and updates on product, engineering, and AI at Stomatiq.";
---

<BaseLayout title={pageTitle}>
  <main class="mx-auto max-w-6xl px-4 md:px-0 py-10">
    <article class="space-y-12">
      <header class="space-y-8">
        <div
          class="relative overflow-hidden rounded-3xl bg-foreground/80 pb-10 pt-40 text-white"
        >
          <img
            src={post.cover ?? "/images/wave-001.png"}
            alt=""
            class="pointer-events-none absolute inset-0 h-full w-full object-cover"
            loading="lazy"
            aria-hidden="true"
          />
          <div class="relative space-y-4 px-6 md:px-10">
            <h1
              class="bg-black/80 p-4 text-4xl font-mono uppercase tracking-[0.2em] md:text-5xl w-fit"
            >
              {post.title}
            </h1>
            <p
              class="italic max-w-2xl bg-black/80 px-4 py-3 text-[16px] leading-7 text-white/90 w-fit"
            >
              {heroDescription}
            </p>
          </div>
        </div>
      </header>
      <div class="mt-8 flex flex-col-reverse gap-10 lg:flex-row">
        <aside
          class="space-y-4 self-start rounded-2xl border border-foreground/10 bg-background-alt/40 p-6 shadow-sm lg:sticky lg:top-24 lg:w-72 lg:flex-shrink-0"
        >
          <div class="space-y-3">
            <h2
              class="text-sm font-semibold uppercase tracking-[0.2em] text-foreground/60"
            >
              Post Details
            </h2>
            <dl class="space-y-4 text-sm text-foreground/80">
              <div class="flex flex-col gap-1">
                <dt
                  class="text-xs uppercase tracking-[0.2em] text-foreground/40"
                >
                  Published
                </dt>
                <dd>{formatDate(post.date)}</dd>
              </div>
              <div class="flex flex-col gap-1">
                <dt
                  class="text-xs uppercase tracking-[0.2em] text-foreground/40"
                >
                  Reading Time
                </dt>
                <dd>{post.readingMinutes} min</dd>
              </div>
              {
                post.category && (
                  <div class="flex flex-col gap-1">
                    <dt class="text-xs uppercase tracking-[0.2em] text-foreground/40">
                      Category
                    </dt>
                    <dd>{post.category}</dd>
                  </div>
                )
              }
              {
                post.tags && post.tags.length > 0 && (
                  <div class="flex flex-col gap-2">
                    <dt class="text-xs uppercase tracking-[0.2em] text-foreground/40">
                      Tags
                    </dt>
                    <dd>
                      <ul class="flex flex-wrap gap-2 text-[11px] uppercase tracking-[0.2em] text-foreground/60">
                        {post.tags.map((tag) => (
                          <li class="rounded-full border border-foreground/15 px-3 py-1">
                            {tag}
                          </li>
                        ))}
                      </ul>
                    </dd>
                  </div>
                )
              }
              {
                post.author && (
                  <div class="flex flex-col gap-3">
                    <dt class="text-xs uppercase tracking-[0.2em] text-foreground/40">
                      Author
                    </dt>
                    <dd>
                      <div class="flex items-center gap-3 text-sm text-foreground/80">
                        {post.authorAvatar && (
                          <img
                            src={post.authorAvatar}
                            alt={post.author}
                            class="h-12 w-12 rounded-full object-cover"
                            loading="lazy"
                          />
                        )}
                        <div class="space-y-1">
                          <p class="font-medium text-foreground">
                            {post.author}
                          </p>
                          {post.authorBio && (
                            <p class="text-xs leading-5 text-foreground/60">
                              {post.authorBio}
                            </p>
                          )}
                        </div>
                      </div>
                    </dd>
                  </div>
                )
              }
            </dl>
          </div>
        </aside>
        <div
          class="prose-wrapper mx-auto max-w-3xl space-y-6 text-[15px] leading-7 text-foreground/80 [&_strong]:text-foreground lg:mx-0 lg:flex-1"
        >
          <div
            class="space-y-6 font-serif text-foreground"
            set:html={post.contentHtml}
          />
        </div>
      </div>
    </article>
  </main>
</BaseLayout>
