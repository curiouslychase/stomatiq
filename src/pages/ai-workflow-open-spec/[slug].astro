---
import BaseLayout from "../../layouts/BaseLayout.astro";
import { getAllSpecSectionsMeta, getSpecSection } from "../../lib/spec";

export async function getStaticPaths() {
  const sections = getAllSpecSectionsMeta();
  return sections.map((section) => ({
    params: { slug: section.slug },
  }));
}

const { slug } = Astro.params;
const section = await getSpecSection(String(slug));
if (!section) {
  return Astro.redirect("/ai-workflow-open-spec/");
}

const sections = getAllSpecSectionsMeta();
const pageTitle = `AI Workflow Open Spec â€“ ${section.title}`;
const { Content } = section;
const heroDescription =
  "A common language for weaving together modular programmatic steps with agentic intelligence.";

const resolveAbsoluteUrl = (pathname: string) => {
  const normalized = pathname.startsWith("/") ? pathname : `/${pathname}`;
  if (Astro.site) return new URL(normalized, Astro.site).toString();
  if (Astro.url) return new URL(normalized, Astro.url).toString();
  return normalized;
};

const ogImage = resolveAbsoluteUrl(`/api/spec-og/${section.slug}.png`);
const canonical = resolveAbsoluteUrl(`/ai-workflow-open-spec/${section.slug}/`);
---

<BaseLayout
  title={pageTitle}
  ogImage={ogImage}
  canonical={canonical}
  description={heroDescription}
>
  <main
    class="mx-auto flex w-full max-w-6xl flex-col gap-10 px-4 py-10 lg:flex-row lg:px-0"
  >
    <article class="prose-wrapper flex-1">
      <header>
        <div
          class="relative overflow-hidden rounded-3xl bg-foreground/80 pb-10 pt-40 text-white"
        >
          <img
            src="/images/wave-001.png"
            alt=""
            class="pointer-events-none absolute inset-0 h-full w-full object-cover opacity-100"
            loading="lazy"
            aria-hidden="true"
          />
          <div class="relative space-y-4 px-4">
            <h1
              class="p-4 bg-black/80 inline-block text-5xl font-mono uppercase"
            >
              AI Workflow Open Spec
            </h1>
            <p class="px-4 py-2 bg-black/80 inline-block text-[16px] leading-7 text-white/90 italic">
              {heroDescription}
            </p>
          </div>
        </div>
      </header>
      <div class="mt-8 flex flex-col-reverse lg:flex-row gap-10">
        <aside class="lg:w-72 lg:flex-shrink-0 lg:sticky lg:top-24 self-start">
          <h2 class="text-sm font-semibold uppercase text-foreground/60">
            Specification Sections
          </h2>
          <ol class="mt-4 space-y-2 text-sm">
            {
              sections.map((item, index) => (
                <li>
                  <a
                    href={`/ai-workflow-open-spec/${item.slug}/`}
                    class={`flex items-center gap-4 rounded-md px-4 py-2 transition hover:bg-foreground/5 ${item.slug === section.slug ? "bg-foreground/10 font-semibold" : "bg-transparent"}`}
                  >
                    <span class="text-xs font-mono uppercase tracking-widest text-foreground/60">
                      {String(index + 1).padStart(2, "0")}
                    </span>
                    <span class="leading-5 text-left">
                      {item.title.replace(/^\s*\d+\.\s*/, "")}
                    </span>
                  </a>
                </li>
              ))
            }
          </ol>
        </aside>
        <div>
          <div
            class="spec-content space-y-6 text-[15px] leading-7 text-foreground/80 [&_strong]:text-foreground"
            data-heading-scope
            data-heading-variant="mono"
          >
            <Content />
          </div>
        </div>
      </div>
    </article>
  </main>
</BaseLayout>
